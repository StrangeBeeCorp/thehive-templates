{"_id":"~205054120","_type":"CaseTemplate","_createdBy":"thehive@thehive.local","_updatedBy":"thehive@thehive.local","_createdAt":1758028033982,"_updatedAt":1758028034015,"name":"Azure Tenant Compromise â€“ Containment","displayName":"","description":"# â˜ï¸ Azure Tenant Compromise â€“ Containment\n\n---\n\n## ðŸŽ¯ Usage\n\nQuickly regain control of the compromised Azure tenant by:\n\n* Removing malicious access and applications\n* Cleaning up accounts, configurations, and workloads\n* Deploying durable measures to prevent re-intrusion\n\n---\n\n## âš™ï¸ Prerequisites before starting\n\n* ðŸ‘¥ Staff available with administrative rights on the Azure tenant\n* ðŸ”‘ Valid, uncompromised admin account (ideally Global Administrator)\n* ðŸ‘¥ Technical support quickly mobilizable if the IS is managed\n\n---\n\n## ðŸ“Œ Objective\n\nDetail containment measures and possible actions by compromise type:\n\n* **Case 1**: Compromise of a Microsoft 365 or Entra ID account\n* **Case 2**: Compromise of a Microsoft Azure Entra enterprise application\n* **Case 3**: Compromise of an Azure resource\n* **Case 4**: Unwanted content relay\n* **Case 5**: Information leak\n\n---\n\n## ðŸ“„ Resource\n\nðŸ‘‰ [Full reflex sheet â€“ INTERCERT-FR](https://www.intercert-france.fr/wp-content/uploads/2025/06/fichereflexe-compromissiontenantazure-endiguement.pdf)","severity":1,"severityLabel":"LOW","tags":["m365","entra","containment","entra ID","azure tenant"],"flag":false,"tlp":2,"tlpLabel":"AMBER","pap":2,"papLabel":"AMBER","customFields":[],"tasks":[{"_id":"~41263240","_type":"Task","_createdBy":"thehive@thehive.local","_createdAt":1758028033994,"title":"Case 3: Compromise of an Azure resource","group":"Qualification","description":"## ðŸŽ¯ Objective\n\nIsolate compromised Azure resources and revoke associated credentials to stop malicious activity, limit propagation, and secure service continuity.\n\n---\n\n## ðŸ“Œ Actions\n\n* **Identify the compromised Azure resource and apply appropriate isolation**:\n\n  * **VM**: disconnect NIC, apply restrictive NSG, or pause the VM\n  * **PaaS (App Service, Azure Function)**: temporarily disable the service, block external access via IP restrictions\n  * **Storage Account**: disable public access, regenerate *storage keys*, apply restrictive network firewall\n* Confirm effectiveness of isolation through absence of new alerts (blocked traffic, no more EDR/AV alerts, Microsoft Defender for Cloud signals)\n\n---\n\n* **Revoke compromised credentials linked to Azure resources**\n\n  * Revoke and renew:\n\n    * Keys/secrets in **Azure Key Vault**\n    * Access tokens for **APIs or external services**\n    * Passwords of local technical accounts (VM, services)\n  * Update application configurations to reference new secured credentials\n  * Verify old credentials are no longer usable (practical tests + log analysis)\n\n---\n\n## âœ… Deliverables\n\n* Compromised credentials revoked, new ones deployed in production\n* Old credentials added as observables for tracking and traceability\n* Compromised resources isolated and malicious traffic blocked\n* Logs/alerts before-after and configuration captures added as observables\n* Actions documented in the **activities** of this task","status":"Waiting","flag":false,"order":2,"mandatory":false,"extraData":{}},{"_id":"~41267336","_type":"Task","_createdBy":"thehive@thehive.local","_createdAt":1758028034004,"title":"Case 4: Undesirable content relay","group":"Qualification","description":"## ðŸŽ¯ Objective\n\nRestore and strengthen compromised anti-spam and anti-spoofing configurations to stop ongoing abuse, block email-borne threats, and reduce the risk of recurrence.\n\n---\n\n### ðŸ“Œ Actions\n\n* Restore compromised anti-spam configuration\n\n  * Log in to the allow/block list management portal:\n    [https://security.microsoft.com/tenantAllowBlockList](https://security.microsoft.com/tenantAllowBlockList)\n  * Remove **illegitimate domains** and **addresses** added by the attacker.\n\n---\n\n* Strengthen anti-spam configuration to prevent recurrence\n\n  * Apply stricter policies for **high-risk users** (VIPs, technical accounts, executives).\n  * Log in to preset security policies portal:\n    [https://security.microsoft.com/presetSecurityPolicies](https://security.microsoft.com/presetSecurityPolicies)\n  * Create a **Strict Protection** policy.\n  * Enable **systematic quarantine** for suspicious emails.\n  * Log in to the anti-spam configuration portal:\n    [https://security.microsoft.com/antispam](https://security.microsoft.com/antispam)\n  * Enable **admin notifications** for suspicious bulk send/receive activities.\n\n---\n\n* Restore compromised anti-spoofing policy\n\n  * Log in to anti-phishing management:\n    [https://security.microsoft.com/antiphishing](https://security.microsoft.com/antiphishing)\n  * Review the **anti-phishing policy** settings in Microsoft 365 Defender.\n  * Select the **active rule** and validate the following entries:\n\n    * Manage `[x] senders`\n    * Manage `[x] custom domain(s)`\n    * Manage `[x] approved sender(s) and domain(s)`\n\n---\n\nâœ… **Deliverables**\n\n* List of removed malicious domains/addresses.\n* Reinforced anti-spam policies applied.\n* Restored and validated anti-spoofing policy.\n* Malicious domains and senders added as observables.\n* Actions logged in the **activities** of this task.","status":"Waiting","flag":false,"order":3,"mandatory":false,"extraData":{}},{"_id":"~205136000","_type":"Task","_createdBy":"thehive@thehive.local","_createdAt":1758028033983,"title":"Case 1: Compromise of a Microsoft 365 or Entra ID account","group":"Containment","description":"## ðŸŽ¯ Objective\n\nRegain control of the compromised account and prevent reuse by the attacker.\n\n---\n\n## ðŸ“Œ Actions\n\n* **Reset account passwords**\n\n  * Sign in to [Entra ID](https://entra.microsoft.com)\n  * Go to **Users > Active users**\n  * Select the account â†’ **Reset password** (twice to get a temporary password)\n\n---\n\n* **Revoke active sessions**\n\n  * [Entra ID](https://entra.microsoft.com) â†’ **Active users** â†’ Select the account â†’ **Revoke sessions**\n\n---\n\n* **Disable the account if necessary**\n\n  * [Entra ID](https://entra.microsoft.com) â†’ **Active users** â†’ Select the account â†’ **Edit properties**\n  * **Settings** tab â†’ uncheck *Account enabled* â†’ **Save**\n\n---\n\n* **Require MFA re-registration**\n\n  * [Entra ID](https://entra.microsoft.com) â†’ **Active users** â†’ Select the account â†’ **Authentication methods**\n  * Click **Require re-register MFA** â†’ **OK**\n\n---\n\n* **Harden conditional access policy**\n\n  * Block malicious IP addresses / apply geographic filtering\n  * [Entra ID](https://entra.microsoft.com) â†’ **Protection > Conditional access** â†’ Create a new policy\n\n---\n\n* **Revoke illegitimate Entra ID roles**\n\n  * [Entra ID](https://entra.microsoft.com) â†’ **Active users** â†’ Select the account â†’ **Assigned roles**\n  * Remove illegitimate roles\n\n---\n\n## âœ… Deliverables\n\n* Compromised account secured (password reset, MFA re-registered, sessions revoked)\n* Conditional access and roles reviewed\n* Actions documented in the **activities** of this task","status":"Waiting","flag":false,"order":0,"mandatory":false,"extraData":{}},{"_id":"~205218040","_type":"Task","_createdBy":"thehive@thehive.local","_createdAt":1758028034009,"title":"Case 5: Information leakage","group":"Qualification","description":"## ðŸŽ¯ Objective\n\nRemove all persistence and compromise mechanisms in Exchange Online (rules, delegations, legacy protocols, unauthorized extensions) in order to block data exfiltration, secure mailboxes, and restore a healthy configuration.\n\n---\n\n## ðŸ“Œ Actions\n\n* Remove illegitimate inbox rules\n\n  * Open a PowerShell console.\n    Installing the **ExchangeOnlineManagement** PowerShell module is a prerequisite and can be done with:\n\n  ```powershell\n  Install-Module ExchangeOnlineManagement -Scope CurrentUser\n  ```\n\n  * Connect to Exchange Online PowerShell (replace `<admin@yourdomain.com>`):\n\n  ```powershell\n  Connect-ExchangeOnline -UserPrincipalName <admin@yourdomain.com> -ShowProgress $true\n  ```\n\n  * List inbox rules of a user (replace `<user@yourdomain.com>`):\n\n  ```powershell\n  Get-InboxRule -Mailbox \"<user@yourdomain.com>\"\n  ```\n\n  * Remove illegitimate rules (replace `<RuleName>`):\n\n  ```powershell\n  Remove-InboxRule -Mailbox \"<user@yourdomain.com>\" -Identity \"<RuleName>\"\n  ```\n\n---\n\n* Remove illegitimate transport rules\n\n  * Connect to the **Exchange Admin Center**:\n    [https://admin.exchange.microsoft.com/#/transportrules](https://admin.exchange.microsoft.com/#/transportrules)\n  * Identify suspicious rules (external forwarding, hidden copy).\n  * Disable or delete illegitimate rules.\n  * Restore a clean configuration if a rule export exists.\n\n---\n\n* Disable direct authentication on shared mailboxes (via IMAP, POP, SMTP Auth, MAPI, OWA)\n\n  * Identify all shared mailboxes with direct authentication enabled.\n  * Open a PowerShell console.\n    Installing the **ExchangeOnlineManagement** module is a prerequisite:\n\n  ```powershell\n  Install-Module ExchangeOnlineManagement -Scope CurrentUser\n  ```\n\n  * List shared mailboxes with direct authentication enabled:\n\n  ```powershell\n  Get-Mailbox -RecipientTypeDetails SharedMailbox | Get-CASMailbox\n  ```\n\n  * Disable direct access (IMAP, POP, MAPI, OWA) if enabled (replace `<Mailbox>`):\n\n  ```powershell\n  Set-CASMailbox -Identity \"<Mailbox>\" -MAPIEnabled $false\n  ```\n\n  * Retain access only via delegation on an authenticated user account.\n\n---\n\n* Disable legacy protocols (IMAP, POP, SMTP Auth)\n\n  * Open a PowerShell console.\n    Prerequisite: install the **ExchangeOnlineManagement** module:\n\n  ```powershell\n  Install-Module ExchangeOnlineManagement -Scope CurrentUser\n  ```\n\n  * Check allowed protocols at tenant and user level:\n\n  ```powershell\n  Get-CASMailbox | Where-Object {$_.PopEnabled -eq $true -or $_.ImapEnabled -eq $true}\n  ```\n\n  * Disable obsolete protocols unless strictly required (replace `<user>`):\n\n  ```powershell\n  Set-CASMailbox -Identity \"<user>\" -PopEnabled $false -ImapEnabled $false -SmtpClientAuthenticationDisabled $true\n  ```\n\n  * Monitor whether accounts are still attempting to use these protocols (Defender alerts).\n\n---\n\n* Remove unauthorized attachment extensions\n\n  * Open a PowerShell console.\n    Prerequisite: install the **ExchangeOnlineManagement** module:\n\n  ```powershell\n  Install-Module ExchangeOnlineManagement -Scope CurrentUser\n  ```\n\n  * Connect to Exchange Online PowerShell (replace `<admin@yourdomain.com>`):\n\n  ```powershell\n  Connect-ExchangeOnline -UserPrincipalName <admin@yourdomain.com> -ShowProgress $true\n  ```\n\n  * Modify Exchange Online anti-malware policies. For example, block `.exe`, `.js`, `.vbs`, `.scr`:\n\n  ```powershell\n  New-TransportRule -Name \"Block Executable Attachments\" -AttachmentExtensionMatchesWords \"exe\",\"js\",\"vbs\",\"scr\" -RejectMessageReasonText \"Executable files are blocked for security reasons.\" -Enabled $true\n  ```\n\n  * Add additional rules to block extensions specifically used during the incident.\n  * Define and monitor alerts to identify any compromised accounts not yet detected.\n\n---\n\n* Remove illegitimate mailbox delegations\n\n  * Connect to the **Exchange Admin Center**:\n    [https://admin.cloud.microsoft/exchange#/mailboxes](https://admin.cloud.microsoft/exchange#/mailboxes)\n  * Select the mailbox account.\n  * Remove illegitimate delegations for:\n\n    * Send As\n    * Send on Behalf\n    * Full Access (Read and Manage)\n  * Connect to Exchange Online PowerShell (replace `<admin@yourdomain.com>`):\n\n  ```powershell\n  Connect-ExchangeOnline -UserPrincipalName <admin@yourdomain.com> -ShowProgress $true\n  ```\n\n  * Verify remaining delegations and restore a legitimate configuration if necessary.\n\n---\n\n## âœ… Deliverables\n\n* Target addresses added as observables.\n* List of rules disabled/removed.\n* List of secured mailboxes.\n* List of blocked extensions.\n* List of delegations removed.\n* Trace all actions performed in the **activities** of this task.","status":"Waiting","flag":false,"order":4,"mandatory":false,"extraData":{}},{"_id":"~368992264","_type":"Task","_createdBy":"thehive@thehive.local","_createdAt":1758028033989,"title":"Case 2: Compromise of a Microsoft Azure Entra enterprise application","group":"Containment","description":"### ðŸŽ¯ Objective\n\nIsolate and secure compromised or malicious applications in Entra ID.\n\n---\n\n## ðŸ“Œ Actions\n\n* **Disable sign-in to the compromised or malicious application**\n\n  * Evaluate business impact vs. security risk first.\n  * Sign in to **[https://entra.microsoft.com](https://entra.microsoft.com)**.\n  * Go to **Applications > Enterprise applications**.\n\n    * Select the compromised application (remove filters if needed).\n  * Disable the application: in **Properties**, set *Enabled for user sign-in?* to **No**.\n\n    * Malicious app: delete after investigation.\n    * Compromised app: recreate/configure a new secure app, then delete the old one after investigation.\n  * Explore hardening options:\n\n    * Conditional Access for service identities\n    * Application risk policies\n\n---\n\n* **Review access for a compromised app not disabled**\n\n  * Sign in to **[https://entra.microsoft.com](https://entra.microsoft.com)** > Enterprise applications.\n  * Select the compromised app > **Permissions** > **Review permissions**.\n  * Select \"**This app is malicious and I am compromised**.\"\n  * Run the 3 proposed PowerShell scripts (after installing the `Microsoft.Graph` module with `Install-Module Microsoft.Graph`) to quickly clean authentication configuration:\n\n    1. Remove affected users\n    2. Invalidate refresh tokens\n    3. Revoke all permissions\n  * In **Properties**: require user assignment\n  * In **Permissions**: revoke illegitimate admin and user consents\n  * In **Users and groups**: remove illegitimate affected users\n\n---\n\n* **Reset certificates and secrets of a compromised app not disabled**\n\n  * Sign in to **[https://entra.microsoft.com](https://entra.microsoft.com)** > **Applications > App registrations > Certificates & Secrets**\n  * Delete compromised certificates and secrets\n  * Recreate only legitimate certificates/secrets if needed\n\n---\n\n* **Remove illegitimate Entra ID roles from a compromised app**\n\n  * Sign in to **[https://entra.microsoft.com](https://entra.microsoft.com)** > **Roles and administrators**\n  * Download assignments to quickly identify illegitimate roles\n  * Remove the app from compromised roles\n\n---\n\n* **Restore legitimate roles & administrators configuration**\n\n  * Identify suspicious recent changes\n  * Sign in to **[https://entra.microsoft.com](https://entra.microsoft.com)** > **Enterprise applications > Roles and administrators**\n  * Restore original legitimate configuration\n\n---\n\n* **Restore the legitimate owner of the compromised app**\n\n  * Identify suspicious changes to owners/admins\n  * Sign in to **[https://entra.microsoft.com](https://entra.microsoft.com)** > **App registrations** > select the app\n  * Reassign the legitimate owner\n  * Immediately notify the restored owner to review permissions\n\n---\n\n* **Enforce explicit administrator consent**\n\n  * Sign in to **[https://entra.microsoft.com](https://entra.microsoft.com)** > **Enterprise applications > Consent and permissions**\n  * In **User consent settings**:\n\n    * Allow only for verified publisher apps and low-impact apps\n  * In **Admin consent settings**:\n\n    * Enable \"*Users can request admin consent*\"\n    * Define groups or roles authorized to review requests\n    * Save changes\n\n---\n\n## âœ… Deliverables\n\n* Compromised app isolated/removed\n* Compromised certificates and secrets revoked\n* All actions documented in the **activities** of this task","status":"Waiting","flag":false,"order":1,"mandatory":false,"extraData":{}}],"extraData":{"pageTemplateHeaders":[]}}