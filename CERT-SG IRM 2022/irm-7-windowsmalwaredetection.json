{"_id":"~3768332312","_type":"CaseTemplate","_createdBy":"florian@strangebee.com","_updatedBy":"florian@strangebee.com","_createdAt":1670336986805,"_updatedAt":1670340328807,"name":"IRM-7-WindowsMalwareDetection","displayName":"Windows Malware Detection (CERT-SG IRM7)","titlePrefix":"","description":"This Incident Response Methodology is a cheat sheet dedicated to handlers investigating on a precise security issue.\n\n**WHO SHOULD USE IRM SHEETS?**\n\n- Administrators\n- Security Operation Center\n- CISOs and deputies\n- CERTs (Computer Emergency Response Team)\n\n**Remember: If you face an incident, follow IRM, take notes. Keep calm and contact your business line’s Incident Response team or CERT immediately if needed.**\n\nReferences:\n→ IRM CERT SG: https://github.com/certsocietegenerale/IRM","severity":2,"tags":[],"flag":false,"tlp":2,"pap":2,"customFields":[],"tasks":[{"_id":"~3031056424","_type":"Task","_createdBy":"florian@strangebee.com","_createdAt":1670340328792,"title":"Remediation","group":"default","description":"## OBJECTIVE: TAKE ACTIONS TO REMOVE THE THREAT AND AVOID FUTURE INCIDENTS.\n\n> **WARNING: ONLY START REMEDIATING ONCE YOU ARE 100% SURE THAT YOU HAVE WELL SCOPED UP AND CONTAINED THE PERIMETER - AS TO PREVENT THE ATTACKER FROM LAUNCHING RETALIATION ACTIONS.**\n\n**The most straight-forward way to get rid of the malware is to remasterthe machine.**\n▪ Remove the binaries and the related registry entries.\n▪ Find the best practices to remove the malware. They can usually be found on Antivirus companies’ websites.\n▪ Remove all malicious files installed and persistence mechanisms put in place by the attacker.\n▪ Apply the EDR prevention mode for all identified IOCs.","status":"Waiting","flag":false,"order":3,"extraData":{}},{"_id":"~3686424744","_type":"Task","_createdBy":"florian@strangebee.com","_createdAt":1670340328804,"title":"Lessons learned","group":"default","description":"## OBJECTIVE: DOCUMENT THE INCIDENT’S DETAILS, DISCUSS LESSONS LEARNED, AND ADJUST PLANS AND DEFENSES.\n\n**Report**\nAn incident report should be written and made available to all of the stakeholders.\n\nThe following themes should be described:\n▪ Initial detection\n▪ Actions and timelines\n▪ What went right\n▪ What went wrong\n▪ Incident cost\n▪ Indicators of compromise\n\n---\n**Capitalize**\nActions to improve malware detection and eradication processes should be defined to capitalize on this experience.\nProfiles of acquisition tools can be tweaked to better match artifacts detected during the investigation.","status":"Waiting","flag":false,"order":5,"extraData":{}},{"_id":"~3768348696","_type":"Task","_createdBy":"florian@strangebee.com","_createdAt":1670340328771,"title":"Identification","group":"default","description":"## OBJECTIVE: DETECT THE INCIDENT, DETERMINE ITS SCOPE, AND INVOLVE THE APPROPRIATE PARTIES.\n\n> The family of malware identified will impact the next steps of the incident response. Investigation will be faster for a Potentially Unwanted Software or a Miner. Stealer, Dropper or Ransomware family will imply a deeper analysis and may lead to another kind of incident (please refer to Large scale malware compromise, Ransomware, Windows Intrusion Detection or Worm Infection if needed).\n\n**General signs of malware presence on the desktop**\n\nSeveral leads might hint that the system could be compromised by malware:\n▪ EDR, HIDS, Antivirus software raising an alert, unable to update its signatures, shutting down or unable to run manual scans.\n▪ Unusual hard-disk activity: the hard drive makes huge operations at unexpected times.\n▪ Unusually slow computer: sudden, unexplained slowdowns not related to system usage.\n▪ Unusual network activity: Slow internet connection / poor network share performance at irregular intervals.\n▪ The computer reboots without reason.\n▪ Applications crashing unexpectedly.\n▪ Pop-up windows appearing while browsing the web. (sometimes even without browsing).\n▪ Your IP address (if static) is present on one or more Internet Blocklists.\n▪ People are complaining about you e-mailing them/reaching them by IM etc. while you did not.\n\n> If the issue is considered as strategic (sensitive resources access), a specific crisis management cell should be activated. i.e. Large Scale Compromise IRM-18\n\n**1 – Evidence acquisition**\n\n> **WARNING (VOLATILE DATA):\n> BEFORE CARRYING OUT ANY OTHER ACTIONS, MAKE SURE TO MAKE A VOLATILE MEMORY CAPTURE BY DOWNLOADING AND RUNNING FTK IMAGER, WINPMEM OR ANOTHER UTILITY FROM AN EXTERNAL DRIVE.\n> VOLATILE DATA PROVIDES VALUABLE FORENSIC INFORMATION AND IS STRAIGHTFORWARD TO ACQUIRE.**\n\n▪ Volatile data:\nVolatile data is useful to perform analysis on command line history, network connections, etc. Use “Volatility” if possible.\n▪ Take a triage image:\nUse tools like EDR, FastIR, DFIR Orc, KAPE with preconfigured profiles.\n\n**Or**\n▪ Full disk copy image:\nWith tools like dd, FTKImager, etc.\n\n> Warning: you may need admin privileges on the machine or a write-blocker (physical or logical) depending on the use case.\n\n---\n**2 – Memory analysis:**\n▪ Look for rogue processes\n▪ Review process DLLs and handles\n▪ Check network artifacts\n▪ Look for code injection\n▪ Check the presence of rootkits\n▪ Dump suspicious processes for further analysis\n\n> If the issue is considered as strategic (sensitive resources access), a specific crisis management cell should be activated. i.e. Large Scale Compromise IRM-18\n\n---\n**3 – Identify persistence mechanisms:**\nPersistence can be allowed through different techniques including:\n▪ Scheduled tasks\n▪ Service replacement\n▪ Service creation\n▪ Auto-start registry keys and startup folder\n▪ Dll search order hijacking\n▪ Trojaned legitimate system libraries\n▪ Local Group Policy\n▪ MS office add-in\n▪ Pre-boot persistence (BIOS/UEFI/MBR alteration)\nYou may consider using Microsoft autoruns for a quick win.\n\n---\n**4 – Check Event Logs**\n▪ Scheduled tasks log (creation and execution)\n▪ Account Logon Events (check for out-of-office connections)\n▪ Suspicious local account\n▪ Malicious Services\n▪ Clearing Event Logs\n▪ RDP/TSE Logs\n▪ Powershell Logs\n▪ SMB Logs\n\n---\n**5 – Super-Timeline**\n▪ Process evidence and generate a super-timeline with tools like Log2timeline.\n▪ Analyze the generated timeline with TimelineExplorer or glogg for example.\n\n---\n**6 – To go further**\n▪ Hash lookups\n▪ MFT anomalies and timestamping\n▪ Anti-virus/Yara analysis/Sigma :\n  o Mount the evidence in a read-only mode. Run Anti-virus scan or multiple Yara files for a quickwin detection.\n  o Please note that unknown malware may be not detected.\n\n> If the issue is considered as strategic (sensitive resources access), a specific crisis management cell should be activated. i.e. Large Scale Compromise IRM","status":"Waiting","flag":false,"order":1,"extraData":{}},{"_id":"~3768352792","_type":"Task","_createdBy":"florian@strangebee.com","_createdAt":1670340328799,"title":"Recovery","group":"default","description":"## OBJECTIVE: RESTORE THE SYSTEM TO NORMAL OPERATIONS.\n\nIf possible, reinstall the OS and applications and restore user’s data from clean, trusted backups. If deemed necessary, you may ask your local IT helpdesk to reimage the disk.\n**In case the computer has not been reinstalled completely:**\n▪ Restore files which could have been corrupted by the malware, especially system files.\n▪ Change all the system’s accounts passwords and make your users do so in a secure way.\n▪ Reboot the machine after all the suspicious files have been removed and confirm that the workstation is not exhibiting any unusual behavior. A full, up-to-date AV and EDR scan of the hard-drive and memory are recommended.\n\n**If a user is at the origin of the compromise, you should reinforce security awareness campaigns.**","status":"Waiting","flag":false,"order":4,"extraData":{}},{"_id":"~4259864712","_type":"Task","_createdBy":"florian@strangebee.com","_createdAt":1670340328760,"title":"Preparation","group":"default","description":"## OBJECTIVE: ESTABLISH CONTACTS, DEFINE PROCEDURES, GATHER INFORMATION TO SAVE TIME DURING AN INCIDENT.\n\n▪ Deploy an EDR solution on endpoints and servers\n  o This tool became one of the cornerstones of incident response in case of ransomware or in large scale compromise, facilitating identification, containment, and remediation phases.\n  o Launch EDR Search and AV scan with IOC explicit rules and get first indicators for remediation progress following.\n  o Set your EDR policies in prevent mode to prevent unnecessary business disruption.\n▪ In absence of EDR, a physical access to the suspicious system should be given to the forensic investigator. Physical access is preferred to remote access, as the hacker could detect the investigations done on the system (by using a network sniffer for example).\n▪ A physical copy of the hard-disk might be necessary for forensic and evidence purposes. Finally, if needed, a physical access could be needed to disconnect the suspected machine from any network.\n▪ Acquisition profiles for EDR or tools like FastIR, DFIR Orc, KAPE, DumpIt, FTK Imager, WinPmem must be prepared and tested.\n▪ A good knowledge of the usual network activity of the machine/server is needed. You should have a file on a secure place describing the usual port activity, to compare efficiently to the current state.\n▪ A good knowledge of the usual services running on the machine can be very helpful. Don’t hesitate to ask a Windows Expert for his assistance, when applicable. A good idea is also to have a map of all services/running process of the machine.\n\n---\n**Endpoints**\n▪ Ensure that the monitoring tools are up to date.\n▪ Deploy Sysmon, SmartScreen and apply recommendation baselines from ANSSI and CIS.\n▪ Establish contacts with your network and security operation teams.\n▪ Make sure that an alert notification process is defined and well-known from everyone.\n▪ Make sure all equipment are synchronized with the same NTP.\n▪ Select what kind of files can be lost / stolen and restrict the access for confidential files.\n▪ Make sure that analysis tools are up, functional (Antivirus, EDR, IDS, logs analyzers), not compromised, and up to date.\n▪ Install from the same original master.","status":"Waiting","flag":false,"order":0,"extraData":{}},{"_id":"~4464660536","_type":"Task","_createdBy":"florian@strangebee.com","_createdAt":1670340328777,"title":"Containment","group":"default","description":"## OBJECTIVE: MITIGATE THE ATTACK’S EFFECTS ON THE TARGETED ENVIRONMENT.\n\n> **WARNING (VOLATILE DATA):\n> MEMORY AND SELECTIVE VOLATILE ARTIFACTS’ ACQUISITION MUST BE CARRIED OUT BEFORE THE FOLLOWING STEPS HAVE TAKEN PLACE.**\n\nIf the machine is considered critical for your company’s business activity and can’t be disconnected, backup all important data in case the hacker notices you’re investigating and starts deleting files.\n▪ If possible, isolate the machine via EDR.\n\n**OR**\n▪ If the machine is not considered critical for your company and can be disconnected, shut the machine down the hard way, removing its power plug. If it is a laptop with a battery on, just push the “off” button for a few seconds until the computer switches off.\n\n> Send the suspect binaries to your CERT, or request CERT’s help if you are unsure about the malware’s nature. The CERT should be able to isolate the malicious content and can send it to all AV companies, including your corporate contractors. (The best way is to create a zipped, password-encrypted file ofthe suspicious binary.)\n\n**Offline investigations should be started right away if the live analysis didn’t give any result, but the system should still be considered compromised.**\n▪ Inspect network shares or any publicly accessible folders shared with other users to see if the malware has spread through it.\n▪ More generally, try to find how the attacker got into the system. All leads should be considered. If no computer proof of the intrusion is found, never forget it could come from a physical access or a complicity/stealing of information from an employee.\n▪ Apply fixes when applicable (operating system and applications) in case the attacker used a known vulnerability.","status":"Waiting","flag":false,"order":2,"extraData":{}}]}